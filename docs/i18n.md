# I18n

DTO Toolkit has two independent i18n-related concerns:

1. Locale-dependent **casters** (for parsing/formatting values)
2. Locale-dependent **error message rendering** (for `ProcessingException`)

This page covers both.

---

## Locale-Dependent Casters

Some built-in casters use locale-sensitive PHP internals (`IntlDateFormatter`, `NumberFormatter`), such as:

- `CastTo\LocalizedDateTime`
- `CastTo\DateTimeFromLocalized`
- `CastTo\LocalizedNumber`
- `CastTo\LocalizedCurrency`

These casters rely on `UsesLocaleResolver` (via `UsesParamResolver`) to resolve a locale at runtime.

Resolution is flexible and can come from:

- Explicit attribute arg (example: `locale: 'fr_CH'`)
- Context: `'<context'` resolves to `$dto->contextGet('locale')`
- DTO getter `'<dto'` resolves to `$dto->getLocale()`, or `'<dto:customGetter'`
- `[Provider::class, 'staticMethodName']`
- Runtime default (`locale_get_default()`)

### Example

```php
use Nandan108\DtoToolkit\CastTo\LocalizedDateTime;
use Nandan108\DtoToolkit\Core\FullDto;

final class InvoiceDto extends FullDto
{
    #[CastTo\DateTime(format: DateTimeFormat::SQL)]
    #[CastTo\LocalizedDateTime(locale: '<context')]
    public ?string $issuedAt = null;
}

$dto = InvoiceDto::newWithContext(['locale' => 'fr_CH'])
    ->loadArray(['issuedAt' => '2026-02-10 18:45:00']);
```

For details about parameter-resolution syntax (`'<context'`, `'<dto'`, etc.), see `docs/BuiltInCasters.md`.

---

## Error Message Translation

`ProcessingException` messages are rendered through `ErrorMessageRendererInterface`.

By default, DTO Toolkit uses `DefaultErrorMessageRenderer`, which supports:

- Message templates (`resources/i18n/{locale}/messages.php`)
- Token dictionaries (`resources/i18n/{locale}/tokens.php`)
- Locale fallback chain:
  - `fr_CH` -> `fr` -> mapped default (`fr_FR`, if configured) -> first available `fr_*` -> `en`
- Adapter/project runtime catalog registration

### Built-in Files

Place catalogs in:

- `resources/i18n/en/messages.php`
- `resources/i18n/en/tokens.php`
- Optional additional locales:
  - `resources/i18n/fr/messages.php`
  - `resources/i18n/fr/tokens.php`
  - `resources/i18n/fr_CH/messages.php`
  - ...

### Locale Selection

You can set locale directly:

```php
use Nandan108\DtoToolkit\Support\DefaultErrorMessageRenderer;

DefaultErrorMessageRenderer::setLocale('fr_CH');
```

Or resolve it dynamically:

```php
use Nandan108\DtoToolkit\Support\ContainerBridge;
use Nandan108\DtoToolkit\Support\DefaultErrorMessageRenderer;

DefaultErrorMessageRenderer::setLocaleResolver(
    fn () => ContainerBridge::tryGet('app.locale')
);
```

If nothing is configured:

1. Resolver result (if any)
2. `locale_get_default()` (when `intl` is available)
3. `'en'`

### Register Extra Catalogs (Adapters / Projects)

Adapters can merge additional messages/tokens at boot:

```php
use Nandan108\DtoToolkit\Support\DefaultErrorMessageRenderer;

DefaultErrorMessageRenderer::registerCatalog(
    locale: 'fr',
    messages: [
        'processing.transform.expected' => 'Attendu :expected, obtenu :type.',
    ],
    tokens: [
        'type.string' => 'une chaine',
        'type.numeric_string' => 'une chaine numerique',
    ],
    override: true, // true: replace existing keys; false: fill only missing keys
);
```

Notes:

- Registrations are locale-scoped.
- Specific locale catalogs override generic ones through fallback resolution.
- `:expected` and `:type` are treated as token lists and translated through `tokens.php`.

### Language Default Locale Map (Optional, Recommended for Adapters)

You can define preferred regional defaults per language:

```php
use Nandan108\DtoToolkit\Support\DefaultErrorMessageRenderer;

DefaultErrorMessageRenderer::setLanguageDefaultLocale('fr', 'fr_FR');
DefaultErrorMessageRenderer::setLanguageDefaultLocale('pt', 'pt_BR');

// Or set a full map
DefaultErrorMessageRenderer::setLanguageDefaultLocales([
    'fr' => 'fr_FR',
    'pt' => 'pt_BR',
    'en' => 'en_US',
]);
```

This map is consulted after exact locale and generic language, and before `first(lang_*)`.

### Adapter Wiring Patterns

#### 1) Keep default renderer, customize catalogs/locales

Best when you want DTOT default behavior with framework locale integration.

```php
DefaultErrorMessageRenderer::setLocaleResolver(
    fn () => ContainerBridge::tryGet('app.locale')
);

// Optional adapter-specific additions
DefaultErrorMessageRenderer::registerCatalog('en', messages: [...], tokens: [...]);
DefaultErrorMessageRenderer::registerCatalog('fr', messages: [...], tokens: [...]);
DefaultErrorMessageRenderer::setLanguageDefaultLocales([
    'fr' => 'fr_FR',
    'en' => 'en_US',
]);
```

#### 2) Replace renderer completely

Best when your framework already has a translator service and message domain strategy.

```php
use Nandan108\DtoToolkit\Exception\Process\ProcessingException;

ProcessingException::setMessageRenderer(new MyFrameworkAwareRenderer());
// or ContainerBridge::register(ErrorMessageRendererInterface::class, new MyFrameworkAwareRenderer());
```

#### Runtime Reset Helpers (Useful in Tests)

```php
use Nandan108\DtoToolkit\Support\DefaultErrorMessageRenderer;

DefaultErrorMessageRenderer::resetRuntimeConfig();
// clears locale, resolver, language-default map, and registered runtime catalogs
```

If you need to invalidate only catalog caches:

```php
use Nandan108\DtoToolkit\Support\DefaultErrorMessageRenderer;

DefaultErrorMessageRenderer::clearCatalogCache();
// clears resolved per-locale merged catalogs

DefaultErrorMessageRenderer::clearCatalogCache(reloadBaseCatalogs: true);
// also clears base resource-file cache (resources/i18n/{locale})
```
